<!DOCTYPE html>
<html>
  <head>
    <title>Exploration Game</title>
    <div id="screen">
      <img id="screen-image" src="images/plains_east.png" />
    </div>
  </head>
  <body>
    <button id="left" onclick="player.goLeft ()">Left</button>
    <button id="right" onclick="player.goRight ()">Right</button>
    <button id="forward" onclick="player.goForward ()">Go forward</button>
    <button id="lantern" onclick="lantern.use()">Lantern</button>
    <button id="compass" onclick="compass.use()">Compass</button>
    <button id="shovel" onclick="shovel.use()">Shovel</button>
    <button id="geolocator" onclick="geolocator.use()">Geolocator</button>
    <button id="save-game" onclick="saveGame()">Save Game</button>

    <a id="instructions" href="instructions.html" target="_blank">How to play</a>

    <p id="description-text"></p>

    <style>
      #screen {
        position: absolute;
        top: 5%;
        left: 20%;
        width: 60%;
        height: 70%;
        border: 2px solid whitesmoke;
      }
      #screen-image {
        position: absolute;
        top: 0%;
        left: 0%;
        width: 100%;
        height: 100%;
      }
      #left {
        position: absolute;
        top: 80%;
        left: 40%;
      }
      #right {
        position: absolute;
        top: 80%;
        right: 45%;
      }
      #forward {
        position: absolute;
        top: 80%;
        left: 45%;
      }
      #description-text {
        position: absolute;
        top: 85%;
      }
      #shovel {
        visibility: hidden;
      }
      #instructions {
        position: absolute;
        right: 5%;
      }
      body {
        font-family: arial;
        background-color: black;
        color: white;
        font-size: 20px;
      }
    </style>
    <script src="map.js"></script>
    <script>
      let MAP_SIZE = 13;

      var torches = [
        { x: 9, y: 9, isLit: false },
        { x: 10, y: 6, isLit: false },
        { x: 5, y: 6, isLit: false },
        { x: 2, y: 8, isLit: false },
        { x: 7, y: 12, isLit: false },
        { x: 4, y: 11, isLit: false },
        { x: 3, y: 0, isLit: false },
        { x: 0, y: 2, isLit: false },
        { x: 9, y: 3, isLit: false },
        { x: 4, y: 3, isLit: false },
        { x: 0, y: 6, isLit: false },
        { x: 7, y: 1, isLit: false },
        { x: 6, y: 8, isLit: false },
        { x: 7, y: 5, isLit: false },
        { x: 2, y: 5, isLit: false },
      ];

      var shovelSpots = [
        { x: 1, y: 1, artifact: "Ruby Necklace" },
        { x: 9, y: 1, artifact: "Tennis Ball" },
        { x: 7, y: 3, artifact: "Vinyl Record" },
        { x: 1, y: 5, artifact: "Harmonica" },
        { x: 4, y: 6, artifact: "Old Pocketwatch" },
        { x: 8, y: 6, artifact: "Wooden Flute" },
        { x: 7, y: 8, artifact: "Arrowhead" },
        {
          x: 11,
          y: 8,
          artifact:
            "The General Theory of Employment, Interest, and Money by John Maynard Keynes",
        },
        { x: 4, y: 9, artifact: "Smiling Rock" },
        { x: 8, y: 11, artifact: "Jade Necklace" },
      ];

      let player = {
        direction: "east",
        x: 7,
        y: 9,
        totalTorchesLit: 0,
        lanternLight: 18,
        maxLanternLight: 18,
        artifacts: [],
        hasShovel: false,
        goLeft: function () {
          if (player.direction === "east") {
            player.direction = "north";
          } else if (player.direction === "north") {
            player.direction = "west";
          } else if (player.direction === "west") {
            player.direction = "south";
          } else if (player.direction === "south") {
            player.direction = "east";
          }
          document.getElementById("description-text").innerHTML =
            "You turn left.";
          updateImage();
        },
        goRight: function () {
          if (player.direction === "west") {
            player.direction = "north";
          } else if (player.direction === "north") {
            player.direction = "east";
          } else if (player.direction === "east") {
            player.direction = "south";
          } else if (player.direction === "south") {
            player.direction = "west";
          }
          document.getElementById("description-text").innerHTML =
            "You turn right.";
          updateImage();
        },
        goForward: function () {
          if (player.direction === "west" && player.x > 0) {
            if (
              !overworldMap[getIndexFromPosition(player.x - 1, player.y)]
                .isCollidable
            ) {
              player.x--;
              document.getElementById("description-text").innerHTML =
                "You move forward.";
            } else {
              document.getElementById("description-text").innerHTML =
                "You can't move here.";
            }
          } else if (player.direction === "north" && player.y > 0) {
            if (
              !overworldMap[getIndexFromPosition(player.x, player.y - 1)]
                .isCollidable
            ) {
              player.y--;
              document.getElementById("description-text").innerHTML =
                "You move forward.";
            } else {
              document.getElementById("description-text").innerHTML =
                "You can't move here.";
            }
          } else if (player.direction === "east" && player.x < MAP_SIZE - 1) {
            if (
              !overworldMap[getIndexFromPosition(player.x + 1, player.y)]
                .isCollidable
            ) {
              player.x++;
              document.getElementById("description-text").innerHTML =
                "You move forward.";
            } else {
              document.getElementById("description-text").innerHTML =
                "You can't move here.";
            }
          } else if (player.direction === "south" && player.y < MAP_SIZE - 1) {
            if (
              !overworldMap[getIndexFromPosition(player.x, player.y + 1)]
                .isCollidable
            ) {
              player.y++;
              document.getElementById("description-text").innerHTML =
                "You move forward.";
            } else {
              document.getElementById("description-text").innerHTML =
                "You can't move here.";
            }
          }
          console.log(player.x + "," + player.y + " " + player.lanternLight);
          updateImage();

          let torchIndex = getTorchIndexFromPosition(player.x, player.y);
          if (torchIndex !== -1) {
            if (torches[torchIndex].isLit) {
              document.getElementById("description-text").innerHTML =
                "There is an lit torch here. You can relight your lantern.";
            } else {
              document.getElementById("description-text").innerHTML =
                "There is an unlit torch here. Use your lantern to light it!";
            }
          }
          if (player.lanternLight > 0) {
            player.lanternLight--;
          }

          if (player.x === 3 && player.y === 11 && !player.hasShovel) {
            document.getElementById("description-text").innerHTML =
              "You found a shovel!";
            player.hasShovel = true;
            document.getElementById("shovel").style.visibility = "visible";
          }
        },
      };

      let retrievedData = localStorage.getItem("gamedata");
      if (retrievedData !== null) {
        let gameData = JSON.parse(retrievedData);
        shovelSpots = gameData.shovelSpots;
        torches = gameData.torches;
        player.x = gameData.player.x;
        player.y = gameData.player.y;
        player.direction = gameData.player.direction;
        player.totalTorchesLit = gameData.player.totalTorchesLit;
        player.lanternLight = gameData.player.lanternLight;
        player.maxLanternLight = gameData.player.maxLanternLight;
        player.artifacts = gameData.player.artifacts;
        player.hasShovel = gameData.player.hasShovel;

        if (player.hasShovel) {
          document.getElementById("shovel").style.visibility = "visible";
        }
      }

      function getIndexFromPosition(x, y) {
        for (var i = 0; i < overworldMap.length; i++) {
          if (x === overworldMap[i].x && y === overworldMap[i].y) {
            return i;
          }
        }
      }

      function getTorchIndexFromPosition(x, y) {
        let NONE_FOUND = -1;
        for (let i = 0; i < torches.length; i++) {
          if (x === torches[i].x && y === torches[i].y) {
            return i;
          }
        }

        return NONE_FOUND;
      }

      function getShovelSpotIndexFromPosition(x, y) {
        let NONE_FOUND = -1;
        for (let i = 0; i < shovelSpots.length; i++) {
          if (x === shovelSpots[i].x && y === shovelSpots[i].y) {
            return i;
          }
        }

        return NONE_FOUND;
      }

      function updateImage() {
        let roomIndex = 0;
        if (player.lanternLight > 0) {
          if (player.direction === "west") {
            if (player.x === 0) {
              document.getElementById("screen-image").src = "images/cliff.png";
            } else {
              roomIndex = getIndexFromPosition(player.x - 1, player.y);
              document.getElementById("screen-image").src =
                overworldMap[roomIndex].westImage;
            }
          } else if (player.direction === "north") {
            if (player.y === 0) {
              document.getElementById("screen-image").src = "images/cliff.png";
            } else {
              roomIndex = getIndexFromPosition(player.x, player.y - 1);
              document.getElementById("screen-image").src =
                overworldMap[roomIndex].northImage;
            }
          } else if (player.direction === "east") {
            if (player.x === MAP_SIZE - 1) {
              document.getElementById("screen-image").src = "images/cliff.png";
            } else {
              roomIndex = getIndexFromPosition(player.x + 1, player.y);
              document.getElementById("screen-image").src =
                overworldMap[roomIndex].eastImage;
            }
          } else if (player.direction === "south") {
            if (player.y === MAP_SIZE - 1) {
              document.getElementById("screen-image").src = "images/cliff.png";
            } else {
              roomIndex = getIndexFromPosition(player.x, player.y + 1);
              document.getElementById("screen-image").src =
                overworldMap[roomIndex].southImage;
            }
          }
        } else {
          document.getElementById("screen-image").src =
            "images/complete-dark.png";
          document.getElementById("description-text").innerHTML =
            "Your lantern has run out of light. Find a torch to relight it!";
        }
      }

      function saveGame() {
        let gameData = {
          player: player,
          torches: torches,
          shovelSpots: shovelSpots,
        };
        localStorage.setItem("gamedata", JSON.stringify(gameData));
        document.getElementById("description-text").innerHTML = "Saved game!";
      }

      let Item = function (sName, sDescription, fUse) {
        this.name = sName;
        this.description = sDescription;
        this.use = fUse;
      };

      let compass = new Item("Compass", "An old compass.", () => {
        document.getElementById("description-text").innerHTML =
          "Your compass reads: " + player.direction;
      });
      let lantern = new Item("Lantern", "Your trusty light.", () => {
        let torchIndex = getTorchIndexFromPosition(player.x, player.y);

        if (torchIndex !== -1) {
          if (!torches[torchIndex].isLit && player.lanternLight > 0) {
            torches[torchIndex].isLit = true;
            player.totalTorchesLit++;
            document.getElementById("description-text").innerHTML =
              "New torch found!! Total torches lit: " + player.totalTorchesLit;
          } else if (torches[torchIndex].isLit) {
            player.lanternLight = player.maxLanternLight;
            document.getElementById("description-text").innerHTML =
              "Relit lantern at torch!";
            updateImage();
          }
        } else {
          document.getElementById("description-text").innerHTML =
            "You check the lantern. Light left: " + player.lanternLight;
        }
      });
      let shovel = new Item("Shovel", "A worn shovel.", () => {
        let spotIndex = getShovelSpotIndexFromPosition(player.x, player.y);

        if (spotIndex !== -1) {
          document.getElementById("description-text").innerHTML =
            "You dig and find " + shovelSpots[spotIndex].artifact + "!";
          player.artifacts.push(shovelSpots[spotIndex].artifact);
          shovelSpots.splice(spotIndex, 1);
        } else {
          document.getElementById("description-text").innerHTML =
            "You dig a hole with the shovel, but you can't seem to find anything.";
        }
      });
      let geolocator = new Item(
        "Geolocator",
        "It helps you see your position on the map.",
        () => {
          document.getElementById("description-text").innerHTML =
            "Your position: (" + player.x + ", " + player.y + ")";
        }
      );
    </script>
  </body>
</html>
